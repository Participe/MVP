{% extends 'challenge_base.html' %}
{% load i18n %}
{% load accounttags %}

{% block title %}{% trans "Challenge details" %} - {{ block.super }}{% endblock %}
{% load thumbnail %}

{% block extra_script %}
{% endblock %}

{% block extra_content %}
    <div class="row ">
        <div class="span9">
            <div class="well">
                <div class="pull-right">
                </div>
                <img src="{{ challenge.avatar|default:'img/default.jpg'|thumbnail_url:'span9_wide' }}" alt="">
                <p>
                    <h1>
                        {{ challenge.name }} ({{ challenge.duration }}h)
                    </h1>
                </p>
                <p>
                    {{ challenge.start_date }}
                    | {{ challenge.start_time|date:"G:i"|default:"0:00" }}
                    | {{ challenge.location }}
                </p>
                {% if challenge.organization and not challenge.organization.is_deleted %}
                    <p>
                        {% trans "Organized by" %}
                        <a href="{{ challenge.organization.get_absolute_url }}">{{ challenge.organization.name }}</a>
                    </p>
                {% endif %}
                <blockquote>
                    <p>{{ challenge.description }}</p>
                </blockquote>

                <h3>{% trans "Participants" %}</h3>
                <ul class="thumbnails">
                    {% for participation in confirmed %}
                        {% need_to_know_tag request participation.user as need_to_know %}
                        {% sum_of_hours_spent_tag participation.user as sum_of_hours_spent %}
                        {% with participation.user.get_profile as profile %}
                        <li class="span2">
                            {% if is_admin %}
                                <div class="thumbnail well">
                                    <a href="{% url view_profile participation.user.pk %}">
                                        {% if not need_to_know and profile.privacy_mode == PRIVACY_MODE.PARANOID %}
                                            <img src="{% thumbnail 'img/default.jpg' 130x130 crop %}" alt="{% trans 'Anonymous User' %}">
                                            <h4>{% trans "Anonymous User" %}</h4>
                                        {% else %}
                                            <img src="{% thumbnail profile.avatar|default:'img/default.jpg' 130x130 crop %}" alt="{{ particiation.user.get_full_name }}">
                                            <h4>{{ participation.user.get_full_name }} {% if sum_of_hours_spent %}<span class="badge">{{ sum_of_hours_spent }}</span>{% endif %}</h4>
                                        {% endif %}
                                    </a>
                                    <input type="button" class="btn" participation="{{ participation.pk }}" value="{% trans 'Remove' %}" onclick="send_remove_form( {{ PARTICIPATION_REMOVE_MODE.REMOVE_APPLICATION }} )">
                                </div>
                            {% else %}
                                <a class="thumbnail well" href="{% url view_profile participation.user.pk %}">
                                    {% if not need_to_know and profile.privacy_mode == PRIVACY_MODE.PARANOID %}
                                        <img src="{% thumbnail 'img/default.jpg' 130x130 crop %}" alt="{% trans 'Anonymous User' %}">
                                        <h4>{% trans "Anonymous User" %}</h4>
                                    {% else %}
                                        <img src="{% thumbnail profile.avatar|default:'img/default.jpg' 130x130 crop %}" alt="{{ particiation.user.get_full_name }}">
                                        <h4>{{ participation.user.get_full_name }} {% if sum_of_hours_spent %}<span class="badge">{{ sum_of_hours_spent }}</span>{% endif %}</h4>
                                    {% endif %}
                                </a>
                            {% endif %}
                        </li>
                        {% endwith %}
                    {% empty %}
                        <li>{% trans "No participants yet" %}</li>
                    {% endfor %}
                </ul>
            </div>

            {% if waiting_for_confirmation and is_admin %}
                <h3>{% trans "People waiting for confirmation" %}</h3>
                <ul class="thumbnails">
                    {% for participation in waiting_for_confirmation %}
                        {% need_to_know_tag request participation.user as need_to_know %}
                        {% sum_of_hours_spent_tag participation.user as sum_of_hours_spent %}
                        {% with participation.user.get_profile as profile %}
                        <li class="span3">
                            <div class="thumbnail well">
                                <a href="{% url view_profile participation.user.pk %}">
                                    {% if not need_to_know and profile.privacy_mode == PRIVACY_MODE.PARANOID %}
                                        <img src="{% thumbnail 'img/default.jpg' 130x130 crop %}" alt="{% trans 'Anonymous User' %}">
                                        <h4>{% trans "Anonymous User" %}</h4>
                                    {% else %}
                                        <img src="{% thumbnail profile.avatar|default:'img/default.jpg' 130x130 crop %}" alt="{{ particiation.user.get_full_name }}">
                                        <h4>{{ participation.user.get_full_name }} {% if sum_of_hours_spent %}<span class="badge">{{ sum_of_hours_spent }}</span>{% endif %}</h4>
                                    {% endif %}
                                </a>
                                <blockquote>
                                    {{ participation.application_text }}
                                </blockquote>
                                <a href="#" onclick="send_accept_form()">
                                    <input type="button" participation="{{ participation.pk }}" value="{% trans "Accept" %}">
                                </a>
                                <input type="button" participation="{{ participation.pk }}" value="{% trans "Reject" %}" onclick="send_remove_form( {{ PARTICIPATION_REMOVE_MODE.REJECT_APPLICATION }} )">
                            </div>
                        </li>
                        {% endwith %}
                    {% endfor %}
                </ul>
            {% endif %}

            {% if waiting_for_acknowledgement and is_admin %}
                <h3>{% trans "Please acknowledge these experience reports" %}</h3>
                <ul class="thumbnails">
                    {% for participation in waiting_for_acknowledgement %}
                        {% need_to_know_tag request participation.user as need_to_know %}
                        {% sum_of_hours_spent_tag participation.user as sum_of_hours_spent %}
                        {% with participation.user.get_profile as profile %}
                        <li class="span3">
                            <div class="thumbnail well">
                                <a href="{% url view_profile participation.user.pk %}">
                                    {% if not need_to_know and profile.privacy_mode == PRIVACY_MODE.PARANOID %}
                                        <img src="{% thumbnail 'img/default.jpg' 130x130 crop %}" alt="{% trans 'Anonymous User' %}">
                                        <h4>{% trans "Anonymous User" %}</h4>
                                    {% else %}
                                        <img src="{% thumbnail profile.avatar|default:'img/default.jpg' 130x130 crop %}" alt="{{ particiation.user.get_full_name }}">
                                        <h4>{{ participation.user.get_full_name }} {% if sum_of_hours_spent %}<span class="badge">{{ sum_of_hours_spent }}</span>{% endif %}</h4>
                                    {% endif %}
                                </a>
                                <p>{% trans "What did you do?" %}</p>
                                <blockquote>{{ participation.selfreflection_activity_text }}</blockquote>
                                <p>{% trans "What did you learn?" %}</p>
                                <blockquote>{{ participation.selfreflection_learning_text }}</blockquote>

                                <input class="btn btn-success" type="button" participation="{{ participation.pk }}" value="{% trans "Acknowledge" %}" onclick="accept_reject_selfreflection_form( {{ PARTICIPATION_REMOVE_MODE.ACKNOWLEDGE }} )">
                                <input class="btn btn-danger" type="button" participation="{{ participation.pk }}" value="{% trans "Reject self-reflection" %}" onclick="accept_reject_selfreflection_form( {{ PARTICIPATION_REMOVE_MODE.REJECT_SELFREFLECTION }} )">

                                <div id="accept-reject-selfreflection-{{ participation.pk }}" class="admin-selfreflection">
                                    <form id="accept-reject-selfreflection-form" action="{% url ajax_accept_reject_selfreflection challenge.pk %}" method="post">{% csrf_token %}
                                        <textarea id="text" name="text" rows="5" cols="20" placeholder="Enter text here"></textarea>
                                        <div class="btn-group">
                                            <input class="btn" type="button" value="Send" onclick="send_accept_reject_selfreflection_form()"></input>
                                            <input id="cancel-btn" name="btn cancel-btn" class="btn" type="button" value="Cancel"></input>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </li>
                        {% endwith %}
                    {% endfor %}
                </ul>
            {% endif %}

            <div class="">
                <h3>{% trans "Comments" %}</h3>
                    {% for comment in comments %}
                        {% need_to_know_tag request comment.user as need_to_know %}
                        {% sum_of_hours_spent_tag comment.user as sum_of_hours_spent %}
                            <blockquote class="">
                                <p>{{ comment.text }}</p>
                                <small>
                                    {% if not need_to_know and comment.user.get_profile.privacy_mode == PRIVACY_MODE.PARANOID %}
                                        <a href="{% url view_profile comment.user.pk %}">{% trans "Anonymous User" %}</a>
                                    {% else %}
                                        <a href="{% url view_profile comment.user.pk %}">{{ comment.user.get_full_name }}</a> {% if sum_of_hours_spent %}<span class="badge">{{ sum_of_hours_spent }}</span>{% endif %}
                                    {% endif %}
                                    {{ comment.created_at }}
                                </small>
                                {% if user == comment.user or is_admin or user.is_staff %}
                                    <a href="#" onclick="delete_comment()"><input url="{% url comment_delete comment.pk %}" type="button" value="Delete"></a>
                                {% endif %}
                        </blockquote>
                {% endfor %}
            <div>
            {% if request.user.is_authenticated %}
                <form id="add-comment-form" action="{% url comment_add %}" method="post">{% csrf_token %}
                    <textarea id="comment" name="comment" rows="5" cols="80"></textarea>
                        <input type="hidden" name="challenge_id" value="{{ challenge.pk }}" /><br>
                        <input id="add-comment-btn" class="btn" type="submit" value="{% trans "Add a comment" %}">
                    </form>
                {% endif %}
                </div>
            </div>
        </div>
        <div class="span3">
            <div class="well">
                {% if challenge.is_overdue %}
                    <p><span class="label">{% trans "This challenge already happened" %}</span></p>
                {% endif %}

                {% if challenge.confirmation_required and not participation.status == PARTICIPATION_STATE.CONFIRMED and not challenge.is_overdue %}
                    <p class="note">
                        <span class="label">{% trans "Confirmation required" %}</span><br>
                        {% if not is_admin %}
                            {% trans "You need to write an application to participate in this challenge. The challenge organizer will use your application text and your history on Participe to decide whether you are a good fit for this challenge." %}
                        {% endif %}
                    </p>
                {% endif %}

                {% if user.is_authenticated %}
                    {% if is_admin %}
                        {% if challenge.is_overdue and challenge.status != CHALLENGE_STATUS.COMPLETED %}
                            <p>
                                <strong>
                                    <span class="label label-warning">{% trans "Please mark this challenge as completed" %}</span><br>
                                    {% trans "If this challenge has taken place as planned, please mark it as completed. Remember to reject all participants from the challenge who did not show up to help, so the challenge will not appear on their profiles." %}
                                </strong>
                            </p>
                            <p><input id="complete-btn" name="complete-btn" type="button" class="btn btn-primary btn-large btn-success" value="{% trans 'Mark as completed' %}"></p>
                            <div id="complete-form">
                                <p class="note">{% trans "The challenge description will appear on the resume of the participants. Please update the description if it not longer properly reflects what happened at the challenge." %}</p>
                                <form action="{% url challenge_complete challenge.pk %}" method="post">{% csrf_token %}
                                    <div class="input"><textarea name="description">{{ challenge.description }}</textarea></div>
                                    <div class="btn-group">
                                        <input type="submit" class="btn btn-success btn-primary" value="{% trans 'Request experience reports' %}" />
                                        <input id="cancel-btn" name="btn cancel-btn" type="button" class="btn" value="{% trans 'Cancel' %}">
                                    </div>
                                </form>
                            </div>
                        {% endif %}
                        {% if challenge.status != CHALLENGE_STATUS.COMPLETED %}
                            <p><a class="btn btn-small" href="{{ challenge.get_edit_url }}">{% trans "Edit challenge" %}</a></p>
                        {% endif %}
                    {% elif participation %}
                        <p class="note">
                            {% if participation.status == PARTICIPATION_STATE.WAITING_FOR_CONFIRMATION %}
                                <span class="label label-info">{{ participation.stat_participation_status_name }}</span><br>
                                {% trans "You have submitted an application to this challenge. You must now wait for the organizer to decide whether they want to accept your offer to help." %}

                            {% elif participation.status == PARTICIPATION_STATE.CONFIRMATION_DENIED %}
                                <span class="label label-error">{{ participation.stat_participation_status_name }}</span>

                            {% elif participation.status == PARTICIPATION_STATE.CONFIRMED %}
                                <span class="label label-success">{{ participation.stat_participation_status_name }}</span><br>
                                {% trans "You are signed up for this challenge. The organizer is expecting you to be there and do your best." %}

                            {% elif participation.status == PARTICIPATION_STATE.CANCELLED_BY_ADMIN %}
                                <span class="label label-error">{{ participation.stat_participation_status_name }}</span>

                            {% elif participation.status == PARTICIPATION_STATE.WAITING_FOR_SELFREFLECTION %}
                                <span class="label label-info">{{ participation.stat_participation_status_name }}</span>

                            {% elif participation.status == PARTICIPATION_STATE.WAITING_FOR_ACKNOWLEDGEMENT %}
                                <span class="label label-info">{{ participation.stat_participation_status_name }}</span>

                            {% elif participation.status == PARTICIPATION_STATE.ACKNOWLEDGED %}
                                <span class="label label-success">{{ participation.stat_participation_status_name }}</span>

                            {% endif %}
                        </p>

                        {% if wform %}
                            <p class="btn-group">
                                <input id="withdraw-btn" name="withdraw-btn" type="button" class="btn btn-danger btn-large" value="{% trans "Withdraw application" %}">
                            </p>
                            <form id="withdraw-form" action="." method="post">{% csrf_token %}
                                <p class="note">
                                    <strong>
                                    <span class="label label-warning">{% trans "Explain yourself" %}</span><br>
                                        {% trans "Withdrawing from a challenge can be very inconvenient for the organizer. Please write a note explaining why you can't make it this time." %}
                                    </strong>
                                </p>
                                <div class="input">
                                    {{ wform.cancellation_text }}{{ form.cancellation_text.errors }}
                                </div>
                                <small>
                                    <p class="note">
                                        <span class="label label-warning">{%  trans "Warning" %}</span><br>
                                        {% trans "If you apply to a challenge in the future, the organizer will be able to see all challenges you withdrew from and the reason you entered. Seeing fewer withdrawals will make you look more trustworthy." %}
                                    </p>
                                </small>
                                <div>
                                    <input id="withdraw" name="withdraw" type="button" class="btn btn-danger btn-mini" value="{% trans 'Withdraw' %}" />
                                    <input id="cancel-btn" name="cancel-btn" type="button" class="btn btn-mini" value="{% trans 'Cancel' %}">
                                </div>
                            </form>
                        {% endif %}
                    {% endif %}

                    {% if not is_admin and sform %}
                        <input id="signup-btn" name="signup-btn" type="button" class="btn btn-primary btn-large btn-success" value="{% trans 'Participate' %}">
                        <div id="signup-form">
                            <form action="." method="post">{% csrf_token %}
                                {% if challenge.application == CHALLENGE_MODE.CONFIRMATION_REQUIRED %}
                                    <div class="input">{{ sform.application_text }}</div>
                                {% endif %}
                                <br/>
                                <small>
                                    <p class="note">
                                        <span class="label label-warning">{% trans "Privacy warning" %}</span>
                                        <br>
                                        {% trans "When you sign up for a challenge, the organizer of the challenge can see your personal information, including telephone number, email, and birth date." %}
                                    </p>
                                </small>
                                <strong>
                                    <p class="note">
                                         <span class="label label-warning">{% trans "This is important" %}</span><br>
                                        {% trans "By clicking participate, you agree to take part in this challenge and to do your best." %}
                                    </p>
                                </strong>
                                {% if user.social_auth.all %}
                                <p>{{ sform.share_on_FB }} <span>{% trans "Share on Facebook" %}</span></p>
                                {% endif %}
                                <div class="btn-group">
                                    <input type="submit" class="btn btn-success btn-primary" onclick="share_on_fb();" value="{% trans 'Participate' %}" />
                                    <input id="cancel-btn" name="btn cancel-btn" type="button" class="btn" value="{% trans 'Cancel' %}">
                                </div>
                            </form>
                        </div>
                    {% endif %}

                    {% if not is_admin and rform %}
                        {% if participation.is_selfreflection_rejected %}
                            <p>{% trans "Your experience report was returned to you with the following note:" %}</p>
                            <blockquote>{{ participation.selfreflection_rejection_text }}</blockquote>
                            <p>{% trans "Please revise your report and submit it again." %}</p>
                            <form action="." method="post">{% csrf_token %}
                                <div class="input">{{ rform.selfreflection_activity_text }}</div>
                                <div class="input">{{ rform.selfreflection_learning_text }}</div>
                                <div class="btn-group">
                                    <input id="selfreflect" type="submit" class="btn btn-success btn-primary" value="{% trans 'Submit' %}" />
                                    <input id="cancel-btn" name="btn cancel-btn" type="button" class="btn" value="{% trans 'Cancel' %}">
                                </div>
                            </form>
                        {% else %}
                            <p><input id="selfrefl-btn" name="selfrefl-btn" type="button" class="btn btn-primary btn-large btn-success" value="{% trans 'Submit your experience' %}"></p>
                            <div id="selfrefl-form">
                                <form action="." method="post">{% csrf_token %}
                                    <p><strong>{% trans "Thank you for participating! Please take a minute to write about your experience." %}</strong></p>
                                    <p>{% trans 'What did you do during this challenge?' %}</p>
                                    <div class="input">{{ rform.selfreflection_activity_text }}</div>
                                    <p>{% trans 'What did you learn? What skills could you practice?' %}</p>
                                    <div class="input">{{ rform.selfreflection_learning_text }}</div>
                                    <div class="btn-group">
                                        <input id="selfreflect" type="submit" class="btn btn-success btn-primary" value="{% trans 'Submit' %}" />
                                        <input id="cancel-btn" name="btn cancel-btn" type="button" class="btn" value="{% trans 'Cancel' %}">
                                    </div>
                                </form>
                            </div>
                        {% endif %}
                    {% endif %}

                    {% if not is_admin and pform %}
                        <input id="nopart-btn" name="nopart-btn" type="button" class="btn btn-primary btn-small btn-danger" value="{% trans 'I did not participate' %}">
                        <div id="nopart-form">
                            <form action="." method="post">{% csrf_token %}
                                <div class="input">{{ pform.cancellation_text }}</div>
                                <div class="btn-group">
                                    <input type="submit" class="btn btn-danger btn-primary" value="{% trans 'Send a reason' %}" />
                                    <input id="cancel-nopart-btn" name="btn cancel-btn" type="button" class="btn" value="{% trans 'Cancel' %}">
                                </div>
                            </form>
                        </div>
                    {% endif %}

                {% else %}
                    <div>
                        <span class="label label-warning">{% trans "Login required" %}</span><br>
                        {% trans "You must have a user account to participate in this challenge." %}
                    </div>
                {% endif %}
            </div>
            <div class="well">
                <h4>{% trans "Contact person" %} </h4>
                {% if challenge.is_contact_person %}
                    <a href="{% url view_profile challenge.contact_person.pk %}">
                        <img src="{{ challenge.contact_person.get_profile.avatar|thumbnail_url:'span3_large' }}" alt="{{ challenge.contact_person.get_full_name }}">
                    </a>
                    <a href="{% url view_profile challenge.contact_person.pk %}">
                        <h3>{{ challenge.contact_person.get_full_name }}</h3>
                    </a>
                        {% if request.user.is_authenticated %}
                            <address>
                                {{ challenge.contact_person.email}} <br>
                                {{ challenge.contact_person.get_profile.phone_number }} <br>
                            </address>
                        {% else %}
                            <p class="note">
                                <span class="label label-warning">{% trans "Information hidden" %}</span><br>
                                {% trans "Log in to see the telephone number and email address of the contact person." %}
                            </p>
                        {% endif %}
                {% else %}
                    <address>
                        <strong>{{ challenge.alt_person_fullname }}</strong><br>
                        {% if request.user.is_authenticated %}
                            {{ challenge.alt_person_email }} <br>
                            {{ challenge.alt_person_phone }} <br>
                        {% else %}
                            <p class="note">
                                <span class="label label-warning">{% trans "Information hidden" %}</span><br>
                                {% trans "Log in to see the telephone number and email address of the contact person.." %}
                            </p>
                        {% endif %}
                    </address>
                {% endif %}
            </div>
            <div class="well">
                {% if user.social_auth.all %}
                    {% with "facebook" as service %}
                        <div class="input"><a href="#" onclick="share_on_fb();"><img src="{{ MEDIA_URL }}img/share_on_FB.jpg" alt="Share on {{ service }}"/></div>
                        <div class="input"><input type="hidden"><a id="share-on-fb" href="http://www.facebook.com/sharer.php?s=100&p[url]={{ request.build_absolute_uri }}&p[images][0]=http://{{ request.get_host }}{{ challenge.avatar.url }}&p[title]={{ challenge.name }}&p[summary]={{ challenge.description }}" target="_blank" title="Share on {{ service }}"></a></input></div>
                    {% endwith %}
                {% endif %}
                <p>
                    <strong>{% trans "Link to this page" %}</strong>
                    <input type="text" readonly="readonly" onclick="$(this).select();" value="{{ request.build_absolute_uri }}"/>
                </p>
            </div>
        </div>
    </div>

    <div id="remove-participation-dialog">
        <form id="remove-participation-form" action="{% url ajax_participation_remove challenge.pk %}" method="post">{% csrf_token %}
            <textarea id="text" name="text" rows="5" cols="20" placeholder="Enter text here"></textarea>
        </form>
    </div>

    <div id="withdraw-dialog">
        <span>{% trans "Do you really want to withdraw your application?" %}</span>
    </div>

    <div id="delete-comment-dialog">
        <p name="header">{%  trans "Are you sure you want to delete this comment?" %}</p>
    </div>

    <script type="text/javascript">
        function share_on_fb(){
            try {
                redirect_to = $("#share-on-fb").attr("href");
                if ($("#id_share_on_FB").is(":checked") && redirect_to){
                    height = 300;
                    width = 500;
                    centeredY = (screen.height - height)/2;
                    centeredX = (screen.width - width)/2;
                    window.open(redirect_to, "_blank", "height="+height+",width="+width+",left="+centeredX+",top="+centeredY).focus();
                }
            } catch(err) {
            }
        }

        /**********************************************************/
        /*** Accept Application                                 ***/
        /**********************************************************/
        function send_accept_form(){
            var event = window.event || evt;
            event.preventDefault();
            if (!event.target) event.target = event.srcElement;
            participation_id = event.target.getAttribute("participation");

            $.post(
                "{% url ajax_participation_accept challenge.pk %}",
                {
                    "participation_id": participation_id
                },
                function(data) {
                    if( data ){
                        $("input[participation="+participation_id+"]").parent().parent().append("<br><span style='color:red;'>"+data+"</span>");
                    } else {
                        $("input[participation="+participation_id+"]").parent().parent().parent().remove();
                    }
                }
            );
        }

        /**********************************************************/
        /*** Remove Participation or Reject Application         ***/
        /**********************************************************/
        function send_remove_form( action_id ){
            var event = window.event || evt;
            event.preventDefault();
            if (!event.target) event.target = event.srcElement;
            participation_id = event.target.getAttribute("participation");

            $("#remove-participation-dialog").data("participation_id", participation_id);
            $("#remove-participation-dialog").data("action_id", action_id);
            $("#remove-participation-dialog").dialog("open");
        }

        $("#remove-participation-dialog").dialog({
            autoOpen: false,
            draggable: true,
            resizable: false,
            modal: true,
            buttons: {
                "Proceed": function(){
                    remove_form = $("#remove-participation-form");
                    participation_id = $(this).data('participation_id');
                    action_id = $(this).data('action_id');

                    var input1 = $("<input>").attr("type", "hidden").attr("name", "participation_id").val(participation_id);
                    var input2 = $("<input>").attr("type", "hidden").attr("name", "action_id").val(action_id);
                    remove_form.append($(input1));
                    remove_form.append($(input2));

                    $.post(
                        remove_form.attr('action'),
                        remove_form.serialize(),
                        function(data) {
                            if( data ){
                                $("input[participation="+participation_id+"]").parent().append("<br><span style='color:red;'>"+data+"</span>");
                            } else {
                                $("input[participation="+participation_id+"]").parent().parent().remove();
                            }
                        }
                    );
                    $(this).dialog('close');
                },
                "Close": function(){
                    $(this).dialog('close');
                }
            }
        });

        /**********************************************************/
        /*** Acknowledge or Reject Participants Self-reflection ***/
        /**********************************************************/
        function accept_reject_selfreflection_form( action_id ){
            var event = window.event || evt;
            event.preventDefault();
            if (!event.target) event.target = event.srcElement;
            participation_id = event.target.getAttribute("participation");
            form = $(event.target).parent().find("#accept-reject-selfreflection-form");

            var input1 = $("<input>").attr("type", "hidden").attr("name", "action_id").val(action_id);
            $("input[name='action_id']").remove();
            form.append($(input1));

            var input2 = $("<input>").attr("type", "hidden").attr("name", "participation_id").val(participation_id);
            $("input[name='participation_id']").remove();
            form.append($(input2));

            $(".admin-selfreflection").hide("slow");
            $("#accept-reject-selfreflection-"+participation_id).show("slow");

            return false;
        }

        function send_accept_reject_selfreflection_form(){
            var event = window.event || evt;
            event.preventDefault();
            if (!event.target) event.target = event.srcElement;

            form = $(event.target).parent().parent();
            participation_id = form.find("input[name='participation_id']").val();

            $.post(
                form.attr('action'),
                form.serialize(),
                function(data) {
                    if( data ){
                        $("#accept-reject-selfreflection-"+participation_id).parent().append("<br><span style='color:red;'>"+data+"</span>");
                    } else {
                        $("#accept-reject-selfreflection-"+participation_id).parent().parent().remove();
                    }
                }
            );
        }

        /**********************************************************/
        /**********************************************************/
        /**********************************************************/
        function delete_comment(){
            var event = window.event || evt;
            event.preventDefault();
            if (!event.target) event.target = event.srcElement;

            var redirect_url = $(event.target).attr("url");

            $("#delete-comment-dialog").data("redirect_url", redirect_url);
            $("#delete-comment-dialog").dialog("open");
        }

        $(document).ready(function(){
            $("#signup-form").hide();
            $("#signup-btn").click(function(){
                $("#signup-btn").hide();
                $('#signup-form').show("slow");
                return false;
            });
            $("#cancel-btn").click(function(){
                $('#signup-form').hide("slow");
                $("#signup-btn").show("slow");
                return false;
            });

            //Acknowledge or Reject Self-reflection form
            $(".admin-selfreflection").hide();
            $("input[id='cancel-btn']").click(function(){
                $(".admin-selfreflection").each( function(index) {
                    $(this).hide("slow");
                });
                return false;
            });

            //Self-reflection form
            $("#selfrefl-form").hide();
            $("#selfrefl-btn").click(function(){
                $("#selfrefl-btn").hide();
                $('#selfrefl-form').show("slow");
                return false;
            });
            $("#cancel-btn").click(function(){
                $('#selfrefl-form').hide("slow");
                $("#selfrefl-btn").show("slow");
                return false;
            });

            //User didnot participate form
            $("#nopart-form").hide();
            $("#nopart-btn").click(function(){
                $("#nopart-btn").hide();
                $('#nopart-form').show("slow");
                return false;
            });
            $("#cancel-nopart-btn").click(function(){
                $('#nopart-form').hide("slow");
                $("#nopart-btn").show("slow");
                return false;
            });

            //Complete challenge form
            $("#complete-form").hide();
            $("#complete-btn").click(function(){
                $("#complete-btn").hide();
                $('#complete-form').show("slow");
                return false;
            });
            $("#cancel-btn").click(function(){
                $('#complete-form').hide("slow");
                $("#complete-btn").show("slow");
                return false;
            });

            //User withdraws his application
            $("#withdraw-form").hide();
            $("#withdraw-btn").click(function(){
                $("#withdraw-btn").hide();
                $('#withdraw-form').show("slow");
                return false;
            });
            $("#cancel-btn").click(function(){
                $('#withdraw-form').hide("slow");
                $("#withdraw-btn").show("slow");
                return false;
            });

            $("#withdraw-dialog").dialog({
                autoOpen: false,
                draggable: true,
                resizable: false,
                modal: true,
                buttons: {
                    "Withdraw": function(){
                        $("#withdraw-form").submit();
                    },
                    "Close": function(){
                        $(this).dialog('close');
                    }
                }
            });

            $('input[id="withdraw"]').click(function(){
                $("#withdraw-dialog").dialog("open");
            });

            //Cancellation text control
            $('#withdraw').attr('disabled','disabled');
            $("#id_cancellation_text").keyup(function() {
                if (this.value.length >= 20){
                    $('#withdraw').removeAttr('disabled');
                } else {
                    $('#withdraw').attr('disabled','disabled');
                }
            });

            //Self-reflection text control
            $('#selfreflect').attr('disabled','disabled');
            $("#id_selfreflection_activity_text, #id_selfreflection_learning_text").keyup(function() {
                if ($("#id_selfreflection_activity_text").val().length >= 20 && $("#id_selfreflection_learning_text").val().length >= 20){
                    $('#selfreflect').removeAttr('disabled');
                } else {
                    $('#selfreflect').attr('disabled','disabled');
                }
            });

            //Add comment control
            $('input[id="add-comment-btn"]').attr('disabled','disabled');
            $("#comment").keyup(function() {
                if (this.value.length >= 1){
                    $('input[id="add-comment-btn"]').removeAttr('disabled');
                } else {
                    $('input[id="add-comment-btn"]').attr('disabled','disabled');
                }
            });

            //Delete comment
            $("#delete-comment-dialog").dialog({
                autoOpen: false,
                draggable: true,
                resizable: false,
                modal: true,
                buttons: {
                    {% trans "Delete" %}: function(){
                        redirect_url = $(this).data("redirect_url");
                        window.location.href = redirect_url;
                    },
                    {% trans "Close" %}: function(){
                        $(this).dialog('close');
                    }
                }
            });
        });
    </script>
{% endblock %}
